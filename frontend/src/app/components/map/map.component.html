<div class="map-wrapper">
  <div class="map-panel">
    <div id="map" class="map-canvas"></div>
  </div>

  <aside class="route-sidebar">
    <div class="route-header">
      <div class="route-header-left">
        <div class="route-tag">
          R-{{
            viewRoute?.id ||
              (optimizedRouteData?.pickUpPointIds?.length ? "OPT" : "")
              | slice : 0 : 8
          }}
        </div>
        <h3 class="route-title">
          {{
            viewRoute?.id
              ? "R-" + (viewRoute?.id | slice : 0 : 8)
              : optimizedRouteData?.pickUpPointIds?.length
              ? "Optimization Report"
              : "Route Details"
          }}
        </h3>
        <p class="muted">Assigned route map and details</p>
      </div>
      <div class="route-header-right">
        <span
          class="status-pill"
          [ngClass]="{
            green:
              (viewRoute?.status || optimizedRouteData?.status) === 'planned',
            orange:
              (viewRoute?.status || optimizedRouteData?.status) ===
              'in_progress'
          }"
        >
          {{ viewRoute?.status || optimizedRouteData?.status || "planned" }}
        </span>
      </div>
    </div>

    <div class="route-card" *ngIf="viewRoute || optimizedRouteData">
      <div class="route-top">
        <div class="route-meta">
          <div>
            <strong>Date:</strong>
            {{
              viewRoute?.routeDate || optimizedRouteData?.routeDate
                | date : "fullDate"
            }}
          </div>
          <div>
            <strong>Status:</strong>
            {{ viewRoute?.status || optimizedRouteData?.status }}
          </div>
        </div>
        <div class="route-stats">
          <div>
            <strong>Distance:</strong>
            {{
              (viewRoute?.totalDistance ||
                optimizedRouteData?.totalDistance ||
                0) / 1000 | number : "1.1-1"
            }}
            km
          </div>
          <div>
            <strong>Time:</strong>
            {{
              (viewRoute?.totalTime || optimizedRouteData?.totalTime || 0) /
                60000 | number : "1.0-0"
            }}
            min
          </div>
        </div>
      </div>

      <div
        class="vehicule-info"
        *ngIf="viewRoute?.vehicule || optimizedRouteData?.vehicule"
      >
        <h4>Vehicle</h4>
        <div class="vehicle-card">
          <div class="vehicle-type">
            {{
              viewRoute?.vehicule?.type ||
                optimizedRouteData?.vehicule?.type ||
                viewRoute?.vehicule?.vehiculeType
            }}
          </div>
          <div class="vehicle-id">
            {{
              viewRoute?.vehicule?.matricul ||
                optimizedRouteData?.vehicule?.matricul ||
                viewRoute?.vehicule?.matricule
            }}
          </div>
        </div>
      </div>

      <div
        class="assigned-users"
        *ngIf="viewRoute?.users?.length || optimizedRouteData?.users?.length"
      >
        <h4>Assigned Employees</h4>
        <ul>
          <li
            *ngFor="
              let u of viewRoute?.users || optimizedRouteData?.users || []
            "
          >
            <strong>{{ u.firstName }} {{ u.lastName }}</strong>
            <span class="role">{{ u.role }}</span>
            <span class="chip" *ngIf="u.driver">Driver</span>
          </li>
        </ul>
      </div>

      <div class="pickups-overview">
        <h4>
          Pickup Points ({{
            viewRoute?.pickUpPoints?.length ||
              optimizedRouteData?.pickUpPointIds?.length ||
              0
          }})
        </h4>
        <ol class="stop-list">
          <ng-container *ngIf="viewRoute?.pickUpPoints?.length">
            <li
              *ngFor="let p of viewRoute?.pickUpPoints; let idx = index"
              class="stop-item"
            >
              <div class="stop-dot" [ngClass]="statusClass(p)"></div>
              <div class="stop-content">
                <div class="stop-meta">STOP {{ idx + 1 }}</div>
                <div class="stop-title">{{ p.name || p._id || p.id }}</div>
                <div class="stop-sub">ID: {{ p._id || p.id }}</div>
              </div>
              <div class="stop-badge">{{ p.containers?.length || 0 }} BINS</div>
            </li>
          </ng-container>
          <ng-container
            *ngIf="
              !viewRoute?.pickUpPoints?.length &&
              optimizedRouteData?.pickUpPointIds?.length
            "
          >
            <li
              *ngFor="
                let pid of optimizedRouteData?.pickUpPointIds;
                let idx = index
              "
              class="stop-item"
            >
              <div class="stop-dot green"></div>
              <div class="stop-content">
                <div class="stop-meta">STOP {{ idx + 1 }}</div>
                <div class="stop-title">{{ pid }}</div>
                <div class="stop-sub">Estimated</div>
              </div>
              <div class="stop-badge">1 BINS</div>
            </li>
          </ng-container>
        </ol>
      </div>
      <div class="route-actions">
        <button
          class="export-btn"
          (click)="saveOptimizedRoute()"
          *ngIf="hasOptimizedRoute()"
        >
          Export Route Plan
        </button>
      </div>
    </div>
  </aside>
</div>
